Neo4j оптимизация запросов туроператора
=======================================

Оптимизируемый запрос

```cypher
profile
match
(d:Destination {name:"Byville"}),
path = shortestPath((c) -[r:ROUTE*]-> (d))
WHERE all(r IN relationships(path) WHERE r.kind = "land")
  and c.name <> 'Byville'
return path
```

```
Planner COST

Runtime PIPELINED

Runtime version 5.9

Batch size 128

+-------------------+----+---------------------------------------------------------------------------------------------+----------------+------+---------+----------------+------------------------+-----------+---------------------+
| Operator          | Id | Details                                                                                     | Estimated Rows | Rows | DB Hits | Memory (Bytes) | Page Cache Hits/Misses | Time (ms) | Pipeline            |
+-------------------+----+---------------------------------------------------------------------------------------------+----------------+------+---------+----------------+------------------------+-----------+---------------------+
| +ProduceResults   |  0 | path                                                                                        |             14 |   16 |     910 |                |                        |           |                     |
| |                 +----+---------------------------------------------------------------------------------------------+----------------+------+---------+----------------+                        |           |                     |
| +ShortestPath     |  1 | path = (c)-[r:ROUTE*]->(d) WHERE all(r IN relationships(path) WHERE r.kind = $autostring_1) |             14 |   16 |    1905 |           3520 |                    0/0 |     4.357 | Fused in Pipeline 3 |
| |                 +----+---------------------------------------------------------------------------------------------+----------------+------+---------+----------------+------------------------+-----------+---------------------+
| +CartesianProduct |  2 |                                                                                             |             18 |   42 |       0 |           2848 |                        |     0.231 | In Pipeline 2       |
| |\                +----+---------------------------------------------------------------------------------------------+----------------+------+---------+----------------+------------------------+-----------+---------------------+
| | +Filter         |  3 | not c.name = $autostring_2                                                                  |             20 |   42 |      43 |                |                        |           |                     |
| | |               +----+---------------------------------------------------------------------------------------------+----------------+------+---------+----------------+                        |           |                     |
| | +AllNodesScan   |  4 | c                                                                                           |             43 |   43 |      44 |            392 |                    1/0 |     0.415 | Fused in Pipeline 1 |
| |                 +----+---------------------------------------------------------------------------------------------+----------------+------+---------+----------------+------------------------+-----------+---------------------+
| +Filter           |  5 | d.name = $autostring_0                                                                      |              1 |    1 |      36 |                |                        |           |                     |
| |                 +----+---------------------------------------------------------------------------------------------+----------------+------+---------+----------------+                        |           |                     |
| +NodeByLabelScan  |  6 | d:Destination                                                                               |             18 |   18 |      19 |            376 |                    3/0 |     0.516 | Fused in Pipeline 0 |
+-------------------+----+---------------------------------------------------------------------------------------------+----------------+------+---------+----------------+------------------------+-----------+---------------------+

Total database accesses: 2957, total allocated memory: 5632
```

Созание индексов

```cypher
create index destNameIndex for (d:Destination) on (d.name);
```

В общем-то, "мертвому припарки" (экономия минимальная)

```
Planner COST

Runtime PIPELINED

Runtime version 5.9

Batch size 128

+-------------------+----+---------------------------------------------------------------------------------------------+----------------+------+---------+----------------+------------------------+-----------+---------------------+
| Operator          | Id | Details                                                                                     | Estimated Rows | Rows | DB Hits | Memory (Bytes) | Page Cache Hits/Misses | Time (ms) | Pipeline            |
+-------------------+----+---------------------------------------------------------------------------------------------+----------------+------+---------+----------------+------------------------+-----------+---------------------+
| +ProduceResults   |  0 | path                                                                                        |             15 |   16 |     910 |                |                        |           |                     |
| |                 +----+---------------------------------------------------------------------------------------------+----------------+------+---------+----------------+                        |           |                     |
| +ShortestPath     |  1 | path = (c)-[r:ROUTE*]->(d) WHERE all(r IN relationships(path) WHERE r.kind = $autostring_1) |             15 |   16 |    1905 |           3520 |                    1/0 |     4.320 | Fused in Pipeline 3 |
| |                 +----+---------------------------------------------------------------------------------------------+----------------+------+---------+----------------+------------------------+-----------+---------------------+
| +CartesianProduct |  2 |                                                                                             |             20 |   42 |       0 |           2848 |                        |     0.328 | In Pipeline 2       |
| |\                +----+---------------------------------------------------------------------------------------------+----------------+------+---------+----------------+------------------------+-----------+---------------------+
| | +Filter         |  3 | not c.name = $autostring_2                                                                  |             20 |   42 |      43 |                |                        |           |                     |
| | |               +----+---------------------------------------------------------------------------------------------+----------------+------+---------+----------------+                        |           |                     |
| | +AllNodesScan   |  4 | c                                                                                           |             43 |   43 |      44 |            392 |                    2/0 |     0.708 | Fused in Pipeline 1 |
| |                 +----+---------------------------------------------------------------------------------------------+----------------+------+---------+----------------+------------------------+-----------+---------------------+
| +NodeIndexSeek    |  5 | RANGE INDEX d:Destination(name) WHERE name = $autostring_0                                  |              1 |    1 |       2 |            376 |                    1/0 |     1.118 | In Pipeline 0       |
+-------------------+----+---------------------------------------------------------------------------------------------+----------------+------+---------+----------------+------------------------+-----------+---------------------+

Total database accesses: 2904, total allocated memory: 5632
```

Несколько веселее себя повело "индексирование" ребер. Индексы влоб не получились. Пришлось ввести сущность наземных маршрутов:

```cypher
match (a) -[:ROUTE {kind:"land"}]-> (b) create (a)-[:ROUTE_LAND]->(b)
```

И переписать запрос

```cypher
profile
match
(d:Destination {name:"Byville"}),
path = shortestPath((c) -[r:ROUTE_LAND*]-> (d))
WHERE c.name <> 'Byville'
return path
```

Получилось на миллисекунду быстрее. Похоже, поиск путей не очень дружит с индексами

```
Planner COST

Runtime PIPELINED

Runtime version 5.9

Batch size 128

+-------------------+----+------------------------------------------------------------+----------------+------+---------+----------------+------------------------+-----------+---------------------+
| Operator          | Id | Details                                                    | Estimated Rows | Rows | DB Hits | Memory (Bytes) | Page Cache Hits/Misses | Time (ms) | Pipeline            |
+-------------------+----+------------------------------------------------------------+----------------+------+---------+----------------+------------------------+-----------+---------------------+
| +ProduceResults   |  0 | path                                                       |             20 |   16 |     182 |                |                        |           |                     |
| |                 +----+------------------------------------------------------------+----------------+------+---------+----------------+                        |           |                     |
| +ShortestPath     |  1 | path = (c)-[r:ROUTE_LAND*]->(d)                            |             20 |   16 |    2380 |           3520 |                    1/0 |     3.128 | Fused in Pipeline 3 |
| |                 +----+------------------------------------------------------------+----------------+------+---------+----------------+------------------------+-----------+---------------------+
| +CartesianProduct |  2 |                                                            |             20 |   42 |       0 |           2848 |                        |     0.160 | In Pipeline 2       |
| |\                +----+------------------------------------------------------------+----------------+------+---------+----------------+------------------------+-----------+---------------------+
| | +Filter         |  3 | not c.name = $autostring_1                                 |             20 |   42 |      43 |                |                        |           |                     |
| | |               +----+------------------------------------------------------------+----------------+------+---------+----------------+                        |           |                     |
| | +AllNodesScan   |  4 | c                                                          |             43 |   43 |      44 |            392 |                    2/0 |     0.529 | Fused in Pipeline 1 |
| |                 +----+------------------------------------------------------------+----------------+------+---------+----------------+------------------------+-----------+---------------------+
| +NodeIndexSeek    |  5 | RANGE INDEX d:Destination(name) WHERE name = $autostring_0 |              1 |    1 |       2 |            376 |                    1/0 |     0.778 | In Pipeline 0       |
+-------------------+----+------------------------------------------------------------+----------------+------+---------+----------------+------------------------+-----------+---------------------+

Total database accesses: 2651, total allocated memory: 5632
```
